#!/bin/bash
#
# BathyCat Seabed Imager - Quick Update Script
# ============================================
# 
# Simple script to update the BathyImager system from GitHub.
#
# Usage: 
#   ./update           - Interactive update with conflict resolution
#   ./update --force   - Force reset to remote version (discards local changes)
#   ./update --stash   - Auto-stash local changes and pull
#
# Author: Mike Bollinger
# Date: August 2025

set -e  # Exit on any error

# Parse command line arguments
FORCE_MODE=false
STASH_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE_MODE=true
            shift
            ;;
        --stash)
            STASH_MODE=true
            shift
            ;;
        --help|-h)
            echo "BathyImager Update Script"
            echo ""
            echo "Usage:"
            echo "  ./update           - Interactive update"
            echo "  ./update --force   - Force reset to remote (loses local changes)"
            echo "  ./update --stash   - Auto-stash and pull"
            echo "  ./update --help    - Show this help"
            echo ""
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

echo "üöÄ BathyImager Seabed Imager - Quick Update"
echo "========================================"

# Check if we're in the right directory
if [ ! -f "src/main.py" ]; then
    echo "‚ùå Error: Not in BathyImager project directory"
    echo "   Please run this script from the project root"
    echo "   Current directory: $(pwd)"
    echo "   Looking for: src/main.py"
    echo "   Expected location: ~/BathyCat-Seabed-Imager"
    ls -la
    exit 1
fi

# Stop any running services
echo "üõë Stopping services..."
sudo systemctl stop bathyimager 2>/dev/null && echo "   Service stopped" || echo "   No service running"

# Backup configuration
echo "üíæ Backing up configuration..."
if [ -f "config/bathyimager_config.json" ]; then
    cp config/bathyimager_config.json config/bathyimager_config.json.backup
    echo "   Configuration backed up"
else
    echo "   No configuration found"
fi

# Show current version
echo "üìç Current version:"
git log --oneline -1

# Fetch and show what's new
echo "üîç Checking for updates..."
git fetch origin
NEW_COMMITS=$(git log --oneline HEAD..origin/main | wc -l)

if [ "$NEW_COMMITS" -eq 0 ]; then
    echo "‚úÖ Already up to date!"
    echo "   To start services: sudo systemctl start bathyimager"
    exit 0
fi

echo "üì• Found $NEW_COMMITS new updates:"
git log --oneline HEAD..origin/main

# Pull updates with conflict resolution
echo "‚¨áÔ∏è  Pulling updates..."

# Check if we have local changes that would conflict
LOCAL_CHANGES=$(git status --porcelain 2>/dev/null)
if [ -n "$LOCAL_CHANGES" ]; then
    echo "‚ö†Ô∏è  Local changes detected:"
    git status --short
    echo ""
    
    # Handle based on mode
    if [ "$FORCE_MODE" = true ]; then
        echo "üö® Force mode: Discarding local changes..."
        git reset --hard origin/main
        echo "‚úÖ Reset complete - all local changes discarded"
    elif [ "$STASH_MODE" = true ]; then
        echo "üì¶ Stash mode: Stashing local changes..."
        git stash push -m "Auto-stash before update $(date '+%Y-%m-%d %H:%M:%S')"
        git pull origin main
        echo "üîÑ Attempting to restore local changes..."
        if git stash pop; then
            echo "‚úÖ Local changes restored successfully"
        else
            echo "‚ö†Ô∏è  Merge conflicts detected - please resolve manually"
            echo "   Your changes are still in git stash"
            echo "   Run: git stash list"
            echo "   Run: git stash show stash@{0}"
        fi
    else
        # Interactive mode
        echo "Update options:"
        echo "1. üîÑ Stash local changes and apply remote updates (RECOMMENDED)"
        echo "2. üö® Force reset to remote version (LOSE local changes)"  
        echo "3. üõë Cancel update"
        echo ""
        read -p "Choose option (1-3): " choice
        
        case $choice in
            1)
                echo "üì¶ Stashing local changes..."
                git stash push -m "Auto-stash before update $(date '+%Y-%m-%d %H:%M:%S')"
                git pull origin main
                echo "üîÑ Attempting to restore local changes..."
                if git stash pop; then
                    echo "‚úÖ Local changes restored successfully"
                else
                    echo "‚ö†Ô∏è  Merge conflicts detected - please resolve manually"
                    echo "   Your changes are still in git stash"
                    echo "   Run: git stash list"
                    echo "   Run: git stash show stash@{0}"
                fi
                ;;
            2)
                echo "üö® Force resetting to remote version..."
                git reset --hard origin/main
                echo "‚úÖ Reset complete - all local changes discarded"
                ;;
            3)
                echo "üõë Update cancelled"
                echo "   To restart services: sudo systemctl start bathyimager"
                exit 0
                ;;
            *)
                echo "‚ùå Invalid choice - cancelling update"
                echo "   To restart services: sudo systemctl start bathyimager"
                exit 1
                ;;
        esac
    fi
else
    # No local changes, normal pull
    git pull origin main
fi

# Update dependencies
echo "üì¶ Updating dependencies..."

# Check if requirements.txt exists
if [ ! -f "requirements.txt" ]; then
    echo "‚ö†Ô∏è  No requirements.txt found - skipping dependency update"
else
    if [ -d "venv" ]; then
        echo "   Using virtual environment..."
        
        # Check if venv is working
        if [ ! -f "venv/bin/activate" ]; then
            echo "‚ö†Ô∏è  Virtual environment appears corrupted"
            echo "   Run: sudo ./scripts/install.sh --update to recreate"
        else
            # Test venv activation first
            if source venv/bin/activate 2>/dev/null; then
                echo "   Virtual environment activated successfully"
                
                # Upgrade pip and tools first
                echo "   Upgrading pip, setuptools, and wheel..."
                venv/bin/pip install --upgrade pip setuptools wheel --no-cache-dir >/dev/null 2>&1 || echo "   Warning: Could not upgrade pip tools"
                
                # Install problematic packages individually with pre-compiled wheels
                echo "   Installing dependencies (this may take a few minutes)..."
                echo "   Note: Using pre-compiled wheels to avoid compilation issues..."
                
                # Method 1: Try with prefer-binary and only-binary for numpy to avoid compilation
                if timeout 600 venv/bin/pip install -r requirements.txt \
                    --upgrade \
                    --no-cache-dir \
                    --prefer-binary \
                    --only-binary=numpy,opencv-python,Pillow \
                    --extra-index-url https://www.piwheels.org/simple \
                    2>/dev/null; then
                    echo "   ‚úÖ Dependencies updated successfully (using pre-compiled wheels)"
                    
                # Method 2: Install numpy specifically from piwheels first, then rest
                elif echo "   Trying alternative approach with piwheels..." && \
                     timeout 300 venv/bin/pip install numpy --upgrade --no-cache-dir \
                         --index-url https://www.piwheels.org/simple \
                         --extra-index-url https://pypi.org/simple 2>/dev/null && \
                     timeout 600 venv/bin/pip install -r requirements.txt \
                         --upgrade --no-cache-dir --prefer-binary 2>/dev/null; then
                    echo "   ‚úÖ Dependencies updated (numpy from piwheels)"
                    
                # Method 3: Try system packages for numpy if available
                elif echo "   Trying with system site packages..." && \
                     timeout 300 venv/bin/pip install -r requirements.txt \
                         --upgrade --no-cache-dir --prefer-binary \
                         --find-links /usr/lib/python3/dist-packages 2>/dev/null; then
                    echo "   ‚úÖ Dependencies updated (using system packages)"
                    
                # Method 4: Last resort - try without numpy and install it separately
                elif echo "   Last resort: Installing without numpy compilation..." && \
                     timeout 300 venv/bin/pip install -r requirements.txt \
                         --upgrade --no-cache-dir --no-deps 2>/dev/null; then
                    echo "   ‚ö†Ô∏è  Dependencies installed without dependency checking"
                    echo "   You may need to verify all dependencies are working"
                else
                    echo "   ‚ö†Ô∏è  Automatic dependency update failed"
                    echo "   Common causes on Raspberry Pi:"
                    echo "   ‚Ä¢ Numpy compilation issues (try: pip install numpy --index-url https://www.piwheels.org/simple)"
                    echo "   ‚Ä¢ Low memory during compilation"
                    echo "   ‚Ä¢ Missing build dependencies"
                    echo "   Manual fix:"
                    echo "   source venv/bin/activate"
                    echo "   pip install numpy --index-url https://www.piwheels.org/simple"
                    echo "   pip install -r requirements.txt --prefer-binary"
                fi
                
                deactivate 2>/dev/null || true
            else
                echo "   ‚ö†Ô∏è  Could not activate virtual environment"
                echo "   Run: sudo ./scripts/install.sh --update to fix"
            fi
        fi
    else
        echo "   No virtual environment found - using system pip..."
        echo "   Installing dependencies (this may take a few minutes)..."
        
        # Upgrade pip first
        pip3 install --upgrade pip setuptools wheel --user --no-cache-dir >/dev/null 2>&1 || echo "   Warning: Could not upgrade pip"
        
        # Try different system pip approaches with better numpy handling
        if timeout 600 pip3 install -r requirements.txt --user --upgrade --no-cache-dir \
            --prefer-binary --only-binary=numpy,opencv-python,Pillow \
            --extra-index-url https://www.piwheels.org/simple 2>/dev/null; then
            echo "   ‚úÖ Dependencies updated successfully (using pre-compiled wheels)"
        elif timeout 300 pip3 install numpy --user --upgrade --no-cache-dir \
             --index-url https://www.piwheels.org/simple \
             --extra-index-url https://pypi.org/simple 2>/dev/null && \
             timeout 600 pip3 install -r requirements.txt --user --upgrade --no-cache-dir --prefer-binary 2>/dev/null; then
            echo "   ‚úÖ Dependencies updated (numpy from piwheels)"
        elif timeout 600 pip3 install -r requirements.txt --user --upgrade --no-cache-dir --prefer-binary --break-system-packages 2>/dev/null; then
            echo "   ‚úÖ Dependencies updated (system override)"
        else
            echo "   ‚ö†Ô∏è  Could not update dependencies automatically"
            echo "   Try these manual steps:"
            echo "   pip3 install numpy --user --index-url https://www.piwheels.org/simple"
            echo "   pip3 install -r requirements.txt --user --prefer-binary --break-system-packages"
        fi
    fi
fi

# Restore configuration
echo "üîß Restoring configuration..."
if [ -f "config/bathyimager_config.json.backup" ]; then
    cp config/bathyimager_config.json.backup config/bathyimager_config.json
    echo "   Configuration restored"
fi

# Fix permissions
echo "üîí Fixing permissions..."
chmod +x scripts/*.sh 2>/dev/null || echo "   Warning: Could not set permissions on scripts"
chmod +x update
chmod +x run_bathyimager.sh 2>/dev/null || echo "   Warning: run_bathyimager.sh not found"
# Ensure Python files are readable
chmod +r src/*.py 2>/dev/null || true
chmod +r config/*.json 2>/dev/null || true

# Show new version
echo "üéâ Updated to:"
git log --oneline -1

# Test the update
echo "üß™ Testing update..."
if [ -d "venv" ] && [ -f "venv/bin/activate" ]; then
    echo "   Testing with virtual environment..."
    if source venv/bin/activate 2>/dev/null; then
        # Test with timeout to prevent hanging
        if timeout 30 venv/bin/python -c "import sys; sys.path.append('src'); import main; print('‚úÖ Main app loads successfully')" 2>/dev/null; then
            echo "   ‚úÖ App test passed"
        else
            echo "   ‚ö†Ô∏è  App test failed or timed out - check for errors"
            echo "   Try: source venv/bin/activate && python src/main.py --help"
        fi
        deactivate 2>/dev/null || true
    else
        echo "   ‚ö†Ô∏è  Could not activate virtual environment for testing"
    fi
else
    echo "   Testing with system Python..."
    # Test with timeout to prevent hanging
    if timeout 30 python3 -c "import sys; sys.path.append('src'); import main; print('‚úÖ Main app loads successfully')" 2>/dev/null; then
        echo "   ‚úÖ App test passed"
    else
        echo "   ‚ö†Ô∏è  App test failed or timed out - check for errors"
        echo "   Try: python3 src/main.py --help"
    fi
fi

echo ""
echo "‚ú® Update complete!"
echo ""
echo "üîß Service Management:"
echo "   To install/update service: sudo ./scripts/install.sh --update"
echo "   To start service:          sudo systemctl start bathyimager"
echo "   To enable auto-start:      sudo systemctl enable bathyimager"
echo "   To check status:           sudo systemctl status bathyimager"
echo "   To view logs:              sudo journalctl -u bathyimager -f"
echo ""
echo "üîß If Virtual Environment Issues Persist:"
echo "   Full reinstall (recreates venv): sudo ./scripts/install.sh --update"
echo "   Manual venv recreation:          rm -rf venv && python3 -m venv venv"
echo "   Manual dependency install:       source venv/bin/activate && pip install -r requirements.txt"
echo ""
echo "üèÉ Manual Running:"
echo "   ‚Ä¢ python3 src/main.py --config config/bathyimager_config.json"
echo "   ‚Ä¢ ./run_bathyimager.sh"
echo ""
echo "üîç Hardware Diagnostics:"
echo "   ‚Ä¢ ./scripts/hardware_diagnostics.sh permissions"
echo "   ‚Ä¢ ./scripts/hardware_diagnostics.sh all"