#!/bin/bash
#
# BathyCat Seabed Imager - Quick Update Script
# ============================================
# 
# Simple script to update the BathyImager system from GitHub.
#
# Usage: 
#   ./update           - Interactive update with conflict resolution
#   ./update --force   - Force reset to remote version (discards local changes)
#   ./update --stash   - Auto-stash local changes and pull
#
# Author: Mike Bollinger
# Date: August 2025

set -e  # Exit on any error

# Parse command line arguments
FORCE_MODE=false
STASH_MODE=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --force)
            FORCE_MODE=true
            shift
            ;;
        --stash)
            STASH_MODE=true
            shift
            ;;
        --help|-h)
            echo "BathyImager Update Script"
            echo ""
            echo "Usage:"
            echo "  ./update           - Interactive update"
            echo "  ./update --force   - Force reset to remote (loses local changes)"
            echo "  ./update --stash   - Auto-stash and pull"
            echo "  ./update --help    - Show this help"
            echo ""
            exit 0
            ;;
        *)
            echo "Unknown option: $1"
            echo "Use --help for usage information"
            exit 1
            ;;
    esac
done

echo "üöÄ BathyImager Seabed Imager - Quick Update"
echo "========================================"

# Check if we're in the right directory
if [ ! -f "src/main.py" ]; then
    echo "‚ùå Error: Not in BathyImager project directory"
    echo "   Please run this script from the project root"
    echo "   Current directory: $(pwd)"
    echo "   Looking for: src/main.py"
    echo "   Expected location: ~/BathyCat-Seabed-Imager"
    ls -la
    exit 1
fi

# Stop any running services
echo "üõë Stopping services..."
sudo systemctl stop bathyimager 2>/dev/null && echo "   Service stopped" || echo "   No service running"

# Backup configuration
echo "üíæ Backing up configuration..."
if [ -f "config/bathyimager_config.json" ]; then
    cp config/bathyimager_config.json config/bathyimager_config.json.backup
    echo "   Configuration backed up"
else
    echo "   No configuration found"
fi

# Show current version
echo "üìç Current version:"
git log --oneline -1

# Fetch and show what's new
echo "üîç Checking for updates..."
git fetch origin
NEW_COMMITS=$(git log --oneline HEAD..origin/main | wc -l)

if [ "$NEW_COMMITS" -eq 0 ]; then
    echo "‚úÖ Already up to date!"
    echo "   To start services: sudo systemctl start bathyimager"
    exit 0
fi

echo "üì• Found $NEW_COMMITS new updates:"
git log --oneline HEAD..origin/main

# Pull updates with conflict resolution
echo "‚¨áÔ∏è  Pulling updates..."

# Check if we have local changes that would conflict
LOCAL_CHANGES=$(git status --porcelain 2>/dev/null)
if [ -n "$LOCAL_CHANGES" ]; then
    echo "‚ö†Ô∏è  Local changes detected:"
    git status --short
    echo ""
    
    # Handle based on mode
    if [ "$FORCE_MODE" = true ]; then
        echo "üö® Force mode: Discarding local changes..."
        git reset --hard origin/main
        echo "‚úÖ Reset complete - all local changes discarded"
    elif [ "$STASH_MODE" = true ]; then
        echo "üì¶ Stash mode: Stashing local changes..."
        git stash push -m "Auto-stash before update $(date '+%Y-%m-%d %H:%M:%S')"
        git pull origin main
        echo "üîÑ Attempting to restore local changes..."
        if git stash pop; then
            echo "‚úÖ Local changes restored successfully"
        else
            echo "‚ö†Ô∏è  Merge conflicts detected - please resolve manually"
            echo "   Your changes are still in git stash"
            echo "   Run: git stash list"
            echo "   Run: git stash show stash@{0}"
        fi
    else
        # Interactive mode
        echo "Update options:"
        echo "1. üîÑ Stash local changes and apply remote updates (RECOMMENDED)"
        echo "2. üö® Force reset to remote version (LOSE local changes)"  
        echo "3. üõë Cancel update"
        echo ""
        read -p "Choose option (1-3): " choice
        
        case $choice in
            1)
                echo "üì¶ Stashing local changes..."
                git stash push -m "Auto-stash before update $(date '+%Y-%m-%d %H:%M:%S')"
                git pull origin main
                echo "üîÑ Attempting to restore local changes..."
                if git stash pop; then
                    echo "‚úÖ Local changes restored successfully"
                else
                    echo "‚ö†Ô∏è  Merge conflicts detected - please resolve manually"
                    echo "   Your changes are still in git stash"
                    echo "   Run: git stash list"
                    echo "   Run: git stash show stash@{0}"
                fi
                ;;
            2)
                echo "üö® Force resetting to remote version..."
                git reset --hard origin/main
                echo "‚úÖ Reset complete - all local changes discarded"
                ;;
            3)
                echo "üõë Update cancelled"
                echo "   To restart services: sudo systemctl start bathyimager"
                exit 0
                ;;
            *)
                echo "‚ùå Invalid choice - cancelling update"
                echo "   To restart services: sudo systemctl start bathyimager"
                exit 1
                ;;
        esac
    fi
else
    # No local changes, normal pull
    git pull origin main
fi

# Update dependencies
echo "üì¶ Updating dependencies..."

# Check if requirements.txt exists
if [ ! -f "requirements.txt" ]; then
    echo "‚ö†Ô∏è  No requirements.txt found - skipping dependency update"
else
    if [ -d "venv" ]; then
        echo "   Using virtual environment..."
        
        # Check if venv is working
        if [ ! -f "venv/bin/activate" ]; then
            echo "‚ö†Ô∏è  Virtual environment appears corrupted"
            echo "   Run: sudo ./scripts/install.sh --update to recreate"
        else
            # Test venv activation first
            if source venv/bin/activate 2>/dev/null; then
                echo "   Virtual environment activated successfully"
                
                # Upgrade pip and tools first
                echo "   Upgrading pip, setuptools, and wheel..."
                venv/bin/pip install --upgrade pip setuptools wheel --no-cache-dir >/dev/null 2>&1 || echo "   Warning: Could not upgrade pip tools"
                
                # Install problematic packages individually with pre-compiled wheels
                echo "   Installing dependencies (this may take a few minutes)..."
                echo "   Note: Using pre-compiled wheels to avoid compilation issues..."
                
                # Install core packages individually to avoid version conflicts
                echo "   Installing core packages individually (avoids version conflicts)..."
                
                # Core packages needed for BathyImager
                CORE_PACKAGES=(
                    "opencv-python"
                    "pynmea2" 
                    "Pillow"
                    "piexif"
                    "pyserial"
                    "psutil"
                    "schedule"
                )
                
                # Install packages one by one with latest versions
                INSTALL_SUCCESS=true
                for package in "${CORE_PACKAGES[@]}"; do
                    echo "     Installing $package..."
                    if timeout 120 venv/bin/pip install --upgrade "$package" \
                        --no-cache-dir \
                        --prefer-binary \
                        --extra-index-url https://www.piwheels.org/simple 2>/dev/null; then
                        echo "     ‚úì $package installed"
                    else
                        echo "     ‚ö† $package failed (continuing)"
                        INSTALL_SUCCESS=false
                    fi
                done
                
                # Handle numpy separately (check system version first)
                echo "     Checking numpy..."
                SYSTEM_NUMPY=$(python3 -c "import numpy; print(numpy.__version__)" 2>/dev/null || echo "none")
                if [[ "$SYSTEM_NUMPY" =~ ^2\. ]]; then
                    echo "     ‚úì Using system numpy $SYSTEM_NUMPY (compatible)"
                else
                    echo "     Installing numpy..."
                    if timeout 120 venv/bin/pip install --upgrade "numpy>=1.19.0" \
                        --no-cache-dir \
                        --prefer-binary \
                        --extra-index-url https://www.piwheels.org/simple 2>/dev/null; then
                        echo "     ‚úì numpy installed"
                    else
                        echo "     ‚ö† numpy failed (may use system version)"
                        INSTALL_SUCCESS=false
                    fi
                fi
                
                # GPIO support for Raspberry Pi
                if [[ "$OSTYPE" == "linux-gnu"* ]]; then
                    echo "     Installing GPIO support..."
                    timeout 60 venv/bin/pip install --upgrade RPi.GPIO \
                        --no-cache-dir --prefer-binary 2>/dev/null || \
                    echo "     ‚ö† GPIO support failed (not critical)"
                fi
                
                if [ "$INSTALL_SUCCESS" = true ]; then
                    echo "   ‚úÖ Dependencies updated successfully (individual packages)"
                else
                    echo "   ‚ö†Ô∏è  Some packages failed but core functionality should work"
                fi
                
                deactivate 2>/dev/null || true
            else
                echo "   ‚ö†Ô∏è  Could not activate virtual environment"
                echo "   Run: sudo ./scripts/install.sh --update to fix"
            fi
        fi
    else
        echo "   No virtual environment found - using system pip..."
        echo "   Installing dependencies (this may take a few minutes)..."
        
        # Upgrade pip first
        pip3 install --upgrade pip setuptools wheel --user --no-cache-dir >/dev/null 2>&1 || echo "   Warning: Could not upgrade pip"
        
        # Install core packages individually for system Python
        echo "   Installing core packages individually..."
        
        CORE_PACKAGES=(
            "opencv-python"
            "pynmea2" 
            "Pillow"
            "piexif"
            "pyserial"
            "psutil"
            "schedule"
        )
        
        INSTALL_SUCCESS=true
        for package in "${CORE_PACKAGES[@]}"; do
            echo "     Installing $package..."
            if timeout 120 pip3 install --upgrade "$package" --user \
                --no-cache-dir \
                --prefer-binary \
                --extra-index-url https://www.piwheels.org/simple 2>/dev/null; then
                echo "     ‚úì $package installed"
            else
                echo "     ‚ö† $package failed (continuing)"
                INSTALL_SUCCESS=false
            fi
        done
        
        # Handle numpy for system Python
        echo "     Installing numpy..."
        if timeout 120 pip3 install --upgrade "numpy>=1.19.0" --user \
            --no-cache-dir \
            --prefer-binary \
            --extra-index-url https://www.piwheels.org/simple 2>/dev/null; then
            echo "     ‚úì numpy installed"
        else
            echo "     ‚ö† numpy failed (may use system version)"
            INSTALL_SUCCESS=false
        fi
        
        if [ "$INSTALL_SUCCESS" = true ]; then
            echo "   ‚úÖ Dependencies updated successfully (individual packages)"
        else
            echo "   ‚ö†Ô∏è  Some packages failed but core functionality should work"
        fi
    fi
fi

# Restore configuration
echo "üîß Restoring configuration..."
if [ -f "config/bathyimager_config.json.backup" ]; then
    cp config/bathyimager_config.json.backup config/bathyimager_config.json
    echo "   Configuration restored"
fi

# Fix permissions
echo "üîí Fixing permissions..."
chmod +x scripts/*.sh 2>/dev/null || echo "   Warning: Could not set permissions on scripts"
chmod +x update
chmod +x run_bathyimager.sh 2>/dev/null || echo "   Warning: run_bathyimager.sh not found"
# Ensure Python files are readable
chmod +r src/*.py 2>/dev/null || true
chmod +r config/*.json 2>/dev/null || true

# Show new version
echo "üéâ Updated to:"
git log --oneline -1

# Test the update
echo "üß™ Testing update..."
if [ -d "venv" ] && [ -f "venv/bin/activate" ]; then
    echo "   Testing with virtual environment..."
    if source venv/bin/activate 2>/dev/null; then
        # Test with timeout to prevent hanging
        if timeout 30 venv/bin/python -c "import sys; sys.path.append('src'); import main; print('‚úÖ Main app loads successfully')" 2>/dev/null; then
            echo "   ‚úÖ App test passed"
        else
            echo "   ‚ö†Ô∏è  App test failed or timed out - check for errors"
            echo "   Try: source venv/bin/activate && python src/main.py --help"
        fi
        deactivate 2>/dev/null || true
    else
        echo "   ‚ö†Ô∏è  Could not activate virtual environment for testing"
    fi
else
    echo "   Testing with system Python..."
    # Test with timeout to prevent hanging
    if timeout 30 python3 -c "import sys; sys.path.append('src'); import main; print('‚úÖ Main app loads successfully')" 2>/dev/null; then
        echo "   ‚úÖ App test passed"
    else
        echo "   ‚ö†Ô∏è  App test failed or timed out - check for errors"
        echo "   Try: python3 src/main.py --help"
    fi
fi

echo ""
echo "‚ú® Update complete!"
echo ""
echo "üîß Service Management:"
echo "   To install/update service: sudo ./scripts/install.sh --update"
echo "   To start service:          sudo systemctl start bathyimager"
echo "   To enable auto-start:      sudo systemctl enable bathyimager"
echo "   To check status:           sudo systemctl status bathyimager"
echo "   To view logs:              sudo journalctl -u bathyimager -f"
echo ""
echo "üîß If Virtual Environment Issues Persist:"
echo "   Full reinstall (recreates venv): sudo ./scripts/install.sh --update"
echo "   Manual venv recreation:          rm -rf venv && python3 -m venv venv"
echo "   Manual dependency install:       source venv/bin/activate && pip install -r requirements.txt"
echo ""
echo "üèÉ Manual Running:"
echo "   ‚Ä¢ python3 src/main.py --config config/bathyimager_config.json"
echo "   ‚Ä¢ ./run_bathyimager.sh"
echo ""
echo "üîç Hardware Diagnostics:"
echo "   ‚Ä¢ ./scripts/hardware_diagnostics.sh permissions"
echo "   ‚Ä¢ ./scripts/hardware_diagnostics.sh all"